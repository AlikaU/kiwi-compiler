#include "ParseTable.h"

#include "GNonTerminal.h"
#include <stdexcept> 




/*
const std::map < std::string, int > ParseTable::terminalsToIndices = {
	{ "EPSILON",0 },
	{ "class",1 },
	{ "id",2 },
	{ "{",3 },
	{ "}",4 },
	{ ";",5 },
	{ "(",6 },
	{ ")",7 },
	{ "program",8 },
	{ "int",9 },
	{ "float",10 },
	{ ".",11 },
	{ "if",12 },
	{ "then",13 },
	{ "else",14 },
	{ "+",15 },
	{ "-",16 },
	{ "numInt",17 },
	{ "numFloat",18 },
	{ "[",19 },
	{ "]",20 },
	{ ",",21 },
	{ "=",22 },
	{ "==",23 },
	{ "<>",24 },
	{ "<",25 },
	{ ">",26 },
	{ "<=",27 },
	{ ">=",28 },
	{ "or",29 },
	{ "*",30 },
	{ "/",31 },
	{ "and",32 },
	{ "$",33 }
};
*/

void  ParseTable::skipXcharsAndClearBuffer(int toSkip) {
	memset(buffer, 0, sizeof(buffer)); // clear buffer
	char c;
	for (int i = 0; i < toSkip; ++i) {
		if (!tableFileStream.get(c)) break;
	}
}

bool ParseTable::init() {
	/*
	table[57][34] = {
		{ 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 },
		{ 0,1,100,100,100,100,100,100,1,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,99 },
		{ 0,2,100,100,100,100,100,100,3,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,4,100,100,100,100,100,100,99,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,5,100,100,99,99,100,100,5,5,100,100,100,100,100,100,100,100,99,100,100,100,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,6,100,7,100,100,100,100,6,6,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,100,100,99,8,9,100,100,100,100,100,100,100,100,100,100,100,100,8,100,100,100,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,10,100,100,100,100,100,100,10,10,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,12,100,13,100,100,100,100,12,12,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,13 },
		{ 0,100,100,100,100,100,100,100,14,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,99 },
		{ 0,100,15,99,100,100,100,100,100,15,15,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,16,100,99,100,100,100,100,16,16,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,99 },
		{ 0,100,100,17,100,99,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,100,100,99,100,100,100,100,18,19,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,20,100,100,100,100,100,100,100,100,21,100,100,100,100,100,100,100,21,100,100,21,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,100,100,100,100,100,100,100,100,100,22,100,100,100,100,100,100,100,22,100,100,22,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,100,100,100,100,100,100,100,100,100,24,100,100,100,100,100,100,100,100,100,100,23,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,25,100,26,100,100,100,100,100,100,100,25,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,27,100,100,100,100,100,100,27,27,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,100,100,100,29,100,29,100,100,100,100,100,100,100,100,100,100,100,28,100,29,100,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,30,100,99,99,100,100,100,100,100,100,31,100,99,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,99,100,99,99,100,100,100,100,100,100,32,100,99,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,33,100,100,99,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,35,34,100,36,100,100,100,100,100,100,35,100,36,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,37,100,100,99,37,99,100,100,100,100,100,100,100,100,100,37,37,100,100,99,100,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,100,100,100,40,100,40,100,100,100,100,100,100,100,38,38,100,100,100,100,40,100,39,39,39,39,39,39,38,100,100,100,100 },
		{ 0,100,41,100,100,99,41,99,100,100,100,100,100,100,100,100,100,41,41,100,99,99,100,99,99,99,99,99,99,100,100,100,100,100 },
		{ 0,100,42,100,100,100,42,100,100,100,100,100,100,100,100,100,100,42,42,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,100,100,100,44,100,44,100,100,100,100,100,100,100,43,43,100,100,100,44,44,100,44,44,44,44,44,44,43,100,100,100,100 },
		{ 0,100,100,100,100,100,100,100,100,100,100,100,100,100,100,45,46,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,47,100,100,99,47,99,100,100,100,100,100,100,100,99,99,47,47,100,99,99,100,99,99,99,99,99,99,99,100,100,100,100 },
		{ 0,100,100,100,100,48,100,48,100,100,100,100,100,100,100,48,48,100,100,100,48,48,100,48,48,48,48,48,48,48,49,49,49,100 },
		{ 0,100,50,100,100,99,53,99,100,100,100,100,100,100,100,99,99,51,52,100,99,99,100,99,99,99,99,99,99,99,99,99,99,100 },
		{ 0,100,54,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,99,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,55,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,100,100,100,100,100,100,100,100,100,56,100,100,100,100,100,100,100,56,100,100,100,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,58,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,99,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,100,100,100,100,100,100,100,100,100,59,100,100,100,100,100,100,100,100,100,100,60,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,61,100,100,99,100,99,100,100,100,100,100,100,100,99,99,100,100,100,99,99,100,99,99,99,99,99,99,99,99,99,99,100 },
		{ 0,100,100,100,100,99,63,99,100,100,100,62,100,100,100,99,99,100,100,62,99,99,100,99,99,99,99,99,99,99,99,99,99,100 },
		{ 0,100,100,100,100,65,100,65,100,100,100,64,100,100,100,65,65,100,100,100,65,65,100,65,65,65,65,65,65,65,65,65,65,100 },
		{ 0,100,66,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,67,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,100,100,100,99,100,99,100,100,100,99,100,100,100,99,99,100,100,69,99,99,99,99,99,99,99,99,99,99,99,99,99,100 },
		{ 0,100,100,100,100,71,100,71,100,100,100,71,100,100,100,71,71,100,100,70,71,71,71,71,71,71,71,71,71,71,71,71,71,100 },
		{ 0,100,100,100,100,99,100,99,100,100,100,100,100,100,100,100,100,100,100,72,100,99,100,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,75,100,100,100,100,100,100,73,74,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,76,100,100,100,100,77,100,76,76,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,100,100,100,100,100,79,100,100,100,100,100,100,100,100,100,100,100,100,100,78,100,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,80,100,100,100,80,81,100,100,100,100,100,100,100,100,100,80,80,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,100,100,100,100,100,83,100,100,100,100,100,100,100,100,100,100,100,100,100,82,100,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,100,100,100,100,100,99,100,100,100,100,100,100,100,100,100,100,100,100,100,84,100,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,100,100,100,100,100,99,100,100,100,100,100,100,100,100,100,100,100,100,100,85,100,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,99,100,100,100,99,100,100,100,100,100,100,100,100,100,100,99,99,100,100,100,86,100,100,100,100,100,100,100,100,100,100,100 },
		{ 0,100,99,100,100,100,99,100,100,100,100,100,100,100,100,100,100,99,99,100,100,100,100,87,88,89,90,91,92,100,100,100,100,100 },
		{ 0,100,99,100,100,100,99,100,100,100,100,100,100,100,100,93,94,99,99,100,100,100,100,100,100,100,100,100,100,95,100,100,100,100 },
		{ 0,100,99,100,100,100,99,100,100,100,100,100,100,100,100,100,100,99,99,100,100,100,100,100,100,100,100,100,100,100,96,97,98,100 }

	};
	*/


	rules = new std::list<GSymbol>[98];
	int ruleNo = 0;

	rulesFileStream.getline(buffer, BUFLEN);
	while (buffer) {

		int idx=0;
		// skip chars until you see a first letter, which is the LHS of the rule
		char c = buffer[idx];
		while (c < 97 && c > 122) {
			++idx;
			c = buffer[idx];
		}

		// get LHS (left hand side) of the rule
		std::string LHS = "";
		while (c != ' ') {
			LHS += c;
			++idx;
			c = buffer[idx];
		}

		rules[ruleNo].push_back(LHS);

		// skip 3 chars, which are " -> "
		idx += 3; 





		rulesFileStream.getline(buffer, BUFLEN);
		if (buffer[0] == '\0') {
			break;
		}
	}

	return initTerminalsToIndices() && initTable();



	rulesFileStream.close();
	

	return initTerminalsToIndices() && initTable();
}

bool ParseTable::initTable() {
	table = new int*[TABLEROWS];
	int row = 0;
	tableFileStream.get(buffer, BUFLEN, ']');
	while (buffer) {

		if (row > TABLEROWS) {
			std::cout << "Unexpected number of rows!";
			return false;
		}

		table[row] = new int[TABLECOLUMNS];

		int column = 0;

		int count = 0;
		std::string word = "";
		while (buffer[count] != '\0') {
			if (buffer[count] != ',') {
				word += buffer[count];
			}
			else {
				try {
					table[row][column] = stoi(word);
				}
				catch (const std::invalid_argument& ia) {
					std::cout << "\nInvalid argument while parsing table: " << ia.what() << '\n';
					return false;
				}
				++column;
				word.clear();
			}
			++count;
		}
		try {
			table[row][column] = stoi(word);
		}
		catch (const std::invalid_argument& ia) {
			std::cout << "\nInvalid argument while parsing table: " << ia.what() << '\n';
			return false;
		}

		skipXcharsAndClearBuffer(3);
		++row;
		tableFileStream.get(buffer, BUFLEN, ']');
		if (buffer[0] == '\0') {
			break;
		}
	}
	skipXcharsAndClearBuffer(0);
	std::cout << "\nInitialized parsing table.";
	tableFileStream.close();
	return true;
}

bool ParseTable::initTerminalsToIndices() {
	// read first row of table, it is our terminalsToIndices conversion chart
	tableFileStream.get(buffer, BUFLEN, ']');
	strncpy_s(terminalsToIndicesString, BUFLEN, buffer, BUFLEN);
	memset(buffer, 0, sizeof(buffer)); // clear buffer
	tableFileStream.get(buffer, BUFLEN, '$');
	strcat_s(terminalsToIndicesString, buffer);
	memset(buffer, 0, sizeof(buffer)); // clear buffer
	tableFileStream.get(buffer, BUFLEN, ']');
	strcat_s(terminalsToIndicesString, buffer);

	// init terminalsToIndices
	int numOfTerminals = 1;
	terminalsToIndices.insert(std::pair<std::string, int>("EPSILON", 0));
	std::string word;
	for (int i = 6; i < sizeof(terminalsToIndicesString); i++) {
		if (terminalsToIndicesString[i] == 0) {
			break;
		}
		if (terminalsToIndicesString[i] == '"') {
			terminalsToIndices.insert(std::pair<std::string, int>("$", numOfTerminals));
			if (numOfTerminals >(TABLECOLUMNS - 1)) {
				std::cout << "Unexpected number of terminals!";
				return false;
			}
			break;
		}
		if (terminalsToIndicesString[i] != '\'') {
			word += terminalsToIndicesString[i];
		}
		else {
			terminalsToIndices.insert(std::pair<std::string, int>(word, numOfTerminals));
			++numOfTerminals;
			i += 4; // skip ","'
			word.clear();
		}
	}



	// cleanup 
	skipXcharsAndClearBuffer(3);
	return true;
}